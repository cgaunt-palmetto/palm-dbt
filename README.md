# Palm dbt

dbt plugin for Palm CLI

This plugin adds dbt-specific commands for use with Palm CLI

## Installing

Install this plugin along with palm

`pip install palm-dbt`

Or from source

`python3 -m pip install .`

### Configuring your project

To configure your project to use the palm-dbt plugin, you will need a `.palm/config.yaml`
this can be created by running `palm scaffold init`, once you have your config file,
add the dbt-palm plugin with the following configuration:

```yaml
plugins:
  - dbt
```

### Adding palm dbt macros

palm-dbt uses the git branch name to set the schema for all commands via env vars.
This allows palm to clean up test data after each run, ensuring that your data 
warehouse stays clean and free of development/test data.

To enable this functionality, palm-dbt ships with 2 macros that handle schema naming
and cleanup.

To install these macros, run `palm install` from within a project that is configured
to use the palm-dbt plugin.

### Recommended (optional) protected branch configuration

In order to ensure your runs are idempotent, we recommend that you do not run 
palm-dbt commands against `main`, `master` or any other production-like branches
you may be using.

To prevent palm running against specific branches, add the following config to
your project's `.palm/config.yaml`

```yaml
protected_branches:
  - main
  - master
  # Any other branches you want to protect
```

## About the palm dbt branch naming macros

Palm-dbt includes 2 macros which are essential to working with dbt in palm.

**generate_schema_name**: This macro will auto-generate a schema name based on your
current git branch. The primary use of this macro is to ensure the generated models
can be cleaned up after each run, since palm can infer the schema name after each run
and clean up with the other macro.

**drop_branch_schemas**: This macro uses the branch named schema and the TEST database
to clean up any models generated by running dbt in development or test environments.
Calls to this macro are baked in to many of the palm dbt commands.

## The (DBT) Flow

From a non-protected branch, running `palm run` will:
1. drop (if it exists) the namespaced schema in development
2. create the namespaced schema in development
3. clean, deps, seed and run
4. drop the namespaced schema in development

Why drop it? so your testing is atomic. 

Want to persist it? use the flag `--persist`
